<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Token 计算器</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-6 md:p-8 rounded shadow-md w-full max-w-md md:max-w-lg lg:max-w-2xl">
        <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">Gemini Token 计算器</h2>

        <div class="mb-4">
            <label for="apiKey" class="block text-gray-700 text-sm font-bold mb-2">API 密钥 <span class="text-red-500">*</span></label>
            <input type="password" id="apiKey" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="请输入你的 Gemini API Key">
            <p class="text-xs text-gray-500 mt-1">API 密钥将存储在浏览器本地存储中，不会上传到任何服务器。</p>
        </div>

        <div class="mb-4">
            <label for="modelName" class="block text-gray-700 text-sm font-bold mb-2">模型名称 (可选)</label>
            <input type="text" id="modelName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="例如: gemini-1.5-flash-latest">
        </div>

        <div class="mb-4">
            <label for="apiVersion" class="block text-gray-700 text-sm font-bold mb-2">API 版本 (可选)</label>
            <input type="text" id="apiVersion" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="例如: v1beta">
        </div>

        <div class="mb-6">
            <label for="inputText" class="block text-gray-700 text-sm font-bold mb-2">输入文本</label>
            <textarea id="inputText" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="5" placeholder="在此输入要计算 token 的文本"></textarea>
        </div>

        <button id="countButton" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline disabled:opacity-50 disabled:cursor-not-allowed">
            计算 Token
        </button>

        <div id="result" class="mt-4 text-gray-700 text-center font-medium"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const apiKeyInput = document.getElementById('apiKey');
            const modelNameInput = document.getElementById('modelName');
            const apiVersionInput = document.getElementById('apiVersion');
            const inputTextarea = document.getElementById('inputText');
            const countButton = document.getElementById('countButton');
            const resultDiv = document.getElementById('result');

            // --- 配置 ---
            const LS_KEYS = {
                API_KEY: 'gemini_apiKey',
                MODEL_NAME: 'gemini_modelName',
                API_VERSION: 'gemini_apiVersion'
            };
            const DEFAULTS = {
                MODEL_NAME: 'gemini-1.5-flash-latest', // 使用 latest 标签通常是好的实践
                API_VERSION: 'v1beta'
            };

            // --- 功能函数 ---

            // 加载设置
            function loadSettings() {
                apiKeyInput.value = localStorage.getItem(LS_KEYS.API_KEY) || '';
                modelNameInput.value = localStorage.getItem(LS_KEYS.MODEL_NAME) || DEFAULTS.MODEL_NAME;
                apiVersionInput.value = localStorage.getItem(LS_KEYS.API_VERSION) || DEFAULTS.API_VERSION;
                 // 如果加载后模型或版本为空，则填充默认值（以防localStorage存了空字符串）
                if (!modelNameInput.value) modelNameInput.value = DEFAULTS.MODEL_NAME;
                if (!apiVersionInput.value) apiVersionInput.value = DEFAULTS.API_VERSION;
            }

            // 保存设置
            function saveSettings() {
                localStorage.setItem(LS_KEYS.API_KEY, apiKeyInput.value);
                // 只有当用户输入了非默认值或非空值时才保存，否则保存默认值，避免存空字符串
                localStorage.setItem(LS_KEYS.MODEL_NAME, modelNameInput.value || DEFAULTS.MODEL_NAME);
                localStorage.setItem(LS_KEYS.API_VERSION, apiVersionInput.value || DEFAULTS.API_VERSION);
            }

            // 处理 Token 计算
            async function handleCountTokens() {
                const apiKey = apiKeyInput.value.trim();
                // 如果用户清空了可选字段，使用默认值
                const modelName = modelNameInput.value.trim() || DEFAULTS.MODEL_NAME;
                const apiVersion = apiVersionInput.value.trim() || DEFAULTS.API_VERSION;
                const inputText = inputTextarea.value;

                resultDiv.textContent = '准备中...';
                resultDiv.className = 'mt-4 text-gray-500 text-center font-medium'; // 重置样式

                if (!apiKey) {
                    resultDiv.textContent = '错误：API 密钥不能为空！';
                    resultDiv.className = 'mt-4 text-red-600 text-center font-medium';
                    apiKeyInput.focus();
                    return;
                }
                 if (!inputText) {
                    resultDiv.textContent = '提示：请输入文本以计算 Token。';
                    resultDiv.className = 'mt-4 text-yellow-600 text-center font-medium';
                    inputTextarea.focus();
                    return;
                }


                // 保存当前有效的设置
                saveSettings();
                // 确保输入框显示的是实际使用的值（包括刚应用的默认值）
                modelNameInput.value = modelName;
                apiVersionInput.value = apiVersion;


                countButton.disabled = true;
                resultDiv.textContent = '正在计算 Token...';
                resultDiv.className = 'mt-4 text-blue-600 text-center font-medium animate-pulse';

                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/${apiVersion}/models/${modelName}:countTokens?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: inputText
                                }],
                            }],
                        }),
                    });

                    if (!response.ok) {
                        let errorMsg = `请求失败，状态码: ${response.status}`;
                        try {
                             const errorData = await response.json();
                             errorMsg = `请求失败: ${errorData?.error?.message || response.statusText}`;
                        } catch (parseError) {
                            console.error("无法解析错误响应:", parseError);
                            errorMsg = `请求失败 (${response.status} ${response.statusText}) 且无法解析错误详情。请检查API Key、模型名称、API版本或网络连接。`;
                        }
                        throw new Error(errorMsg);
                    }

                    const data = await response.json();
                    resultDiv.textContent = `总 Token 数: ${data.totalTokens}`;
                    resultDiv.className = 'mt-4 text-green-700 text-center font-bold text-lg';

                } catch (error) {
                    console.error('Token 计算出错:', error);
                    resultDiv.textContent = `计算时发生错误: ${error.message}`;
                     resultDiv.className = 'mt-4 text-red-600 text-center font-medium';
                } finally {
                    countButton.disabled = false;
                     // 移除动画类
                    resultDiv.classList.remove('animate-pulse');
                }
            }

            // --- 事件监听 ---
            countButton.addEventListener('click', handleCountTokens);

            // --- 初始化 ---
            loadSettings();
             // 页面加载时清空结果区域
            resultDiv.textContent = '';

        });
    </script>
</body>

</html>